#!/bin/bash
# sentra-shell - Sentra REPL wrapper for OpenClaw
#
# This script is used as SHELL by OpenClaw to route all command execution
# through Sentra's policy enforcement. Commands are validated against the
# policy.yaml rules before execution.
#
# Usage:
#   sentra-shell                    # Interactive REPL mode
#   sentra-shell -c "command"       # Execute single command (sh -c compatible)
#   sentra-shell script.sh          # Execute script file
#
# Environment variables:
#   SENTRA_BIN       - Path to Sentra binary (default: /usr/local/bin/sentra)
#   SENTRA_POLICY    - Path to policy.yaml (default: /etc/sentra/policy.yaml)
#   PYTHON_RUNNER    - Path to python_runner (default: /usr/lib/sentra/python_runner)
#   SENTRA_QUIET     - Set to 1 to suppress Sentra banner/status output (default: 1)
#   SENTRA_VERBOSE   - Set to 1 for verbose output

# Prevent recursion - sentra must use real shell, not sentra-shell
export SHELL=/bin/bash

SENTRA_BIN="${SENTRA_BIN:-/usr/local/bin/sentra}"
POLICY_FILE="${SENTRA_POLICY:-/etc/sentra/policy.yaml}"
PYTHON_RUNNER="${PYTHON_RUNNER:-/usr/lib/sentra/python_runner}"
QUIET="${SENTRA_QUIET:-1}"

# Build base args (quiet mode uses native --quiet flag)
QUIET_ARG=""
if [[ "$QUIET" = "1" ]]; then
    QUIET_ARG="--quiet"
fi

# Check if Sentra exists
if [[ ! -x "$SENTRA_BIN" ]]; then
    echo "sentra-shell: ERROR: Sentra not found at $SENTRA_BIN" >&2
    echo "sentra-shell: Install Sentra or set SENTRA_BIN environment variable" >&2
    exit 127
fi

# Check if policy exists
if [[ ! -f "$POLICY_FILE" ]]; then
    echo "sentra-shell: WARNING: Policy file not found at $POLICY_FILE" >&2
    echo "sentra-shell: Commands will use default (restrictive) policy" >&2
fi

# Build Sentra arguments
SENTRA_ARGS=()
if [[ -f "$POLICY_FILE" ]]; then
    SENTRA_ARGS+=("--policy" "$POLICY_FILE")
fi
if [[ -x "$PYTHON_RUNNER" ]]; then
    SENTRA_ARGS+=("--python-runner" "$PYTHON_RUNNER")
fi

# Handle different invocation modes
case "$1" in
    -c)
        # sh -c compatible mode: execute command string
        shift
        if [[ -z "$1" ]]; then
            echo "sentra-shell: -c requires a command string" >&2
            exit 1
        fi

        # Pass command to Sentra REPL via stdin
        if [[ -n "$SENTRA_VERBOSE" ]]; then
            echo "sentra-shell: executing: $*" >&2
        fi

        echo "$*" | "$SENTRA_BIN" $QUIET_ARG "${SENTRA_ARGS[@]}" 2>&1
        ;;

    -i)
        # Interactive mode (explicit)
        shift
        exec "$SENTRA_BIN" "${SENTRA_ARGS[@]}" "$@"
        ;;

    "")
        # No arguments: interactive REPL
        exec "$SENTRA_BIN" "${SENTRA_ARGS[@]}"
        ;;

    *)
        # Script file or command
        if [[ -f "$1" ]]; then
            # Execute script file through Sentra
            SCRIPT="$1"
            shift

            if [[ -n "$SENTRA_VERBOSE" ]]; then
                echo "sentra-shell: executing script: $SCRIPT" >&2
            fi

            # Read script and pipe to Sentra
            cat "$SCRIPT" | "$SENTRA_BIN" $QUIET_ARG "${SENTRA_ARGS[@]}" 2>&1
        else
            # Treat as command string (fallback)
            if [[ -n "$SENTRA_VERBOSE" ]]; then
                echo "sentra-shell: executing: $*" >&2
            fi

            echo "$*" | "$SENTRA_BIN" $QUIET_ARG "${SENTRA_ARGS[@]}" 2>&1
        fi
        ;;
esac
