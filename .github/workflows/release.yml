name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            asset_name: sentra-linux-x86_64

          # Linux ARM64
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            asset_name: sentra-linux-aarch64
            cross: true

          # macOS x86_64
          - target: x86_64-apple-darwin
            os: macos-12
            asset_name: sentra-macos-x86_64

          # macOS ARM64 (Apple Silicon)
          - target: aarch64-apple-darwin
            os: macos-14
            asset_name: sentra-macos-aarch64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install libseccomp-dev (Linux x86_64)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y libseccomp-dev

      - name: Install cross-compilation tools (Linux ARM64)
        if: matrix.cross
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu g++-aarch64-linux-gnu
          # Install libseccomp for cross-compilation
          sudo dpkg --add-architecture arm64
          sudo sed -i 's/^deb /deb [arch=amd64] /' /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs) main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs)-updates main restricted universe multiverse" | sudo tee -a /etc/apt/sources.list
          sudo apt-get update || true
          sudo apt-get install -y libseccomp-dev:arm64 || true
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          echo "PKG_CONFIG_SYSROOT_DIR=/usr/aarch64-linux-gnu" >> $GITHUB_ENV

      - name: Build release binaries
        run: cargo build --release --target ${{ matrix.target }}

      - name: Create release archive
        shell: bash
        run: |
          mkdir -p release-staging
          cp target/${{ matrix.target }}/release/sentra release-staging/
          cp target/${{ matrix.target }}/release/python_runner release-staging/
          cp policy.yaml release-staging/
          cp README.md release-staging/
          cp LICENSE release-staging/
          cd release-staging
          tar -czvf ../${{ matrix.asset_name }}.tar.gz *

      - name: Generate SHA256 checksum
        shell: bash
        run: |
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            shasum -a 256 ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.sha256
          else
            sha256sum ${{ matrix.asset_name }}.tar.gz > ${{ matrix.asset_name }}.sha256
          fi
          cat ${{ matrix.asset_name }}.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.asset_name }}
          path: |
            ${{ matrix.asset_name }}.tar.gz
            ${{ matrix.asset_name }}.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -name '*.tar.gz' -exec mv {} release-assets/ \;
          find artifacts -name '*.sha256' -exec mv {} release-assets/ \;
          # Combine all checksums
          cd release-assets
          cat *.sha256 > checksums.txt
          echo "=== Release Assets ==="
          ls -la
          echo "=== Checksums ==="
          cat checksums.txt

      - name: Get version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Sentra ${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(github.ref, '-rc') || contains(github.ref, '-beta') || contains(github.ref, '-alpha') }}
          files: |
            release-assets/*.tar.gz
            release-assets/checksums.txt
          body: |
            ## Sentra ${{ steps.version.outputs.VERSION }} - Universal Execution Governance Gateway

            Python sandbox execution with kernel-level isolation for OpenClaw VM integration.

            ### Installation

            **Quick Install (auto-detects platform):**
            ```bash
            curl -sSL https://raw.githubusercontent.com/sundarsub/sentra/main/install.sh | bash
            ```

            **Manual Install:**
            ```bash
            # Download for your platform and extract
            tar xzf sentra-<platform>.tar.gz
            sudo mv sentra /usr/local/bin/
            sudo mkdir -p /usr/lib/sentra
            sudo mv python_runner /usr/lib/sentra/
            sudo mkdir -p /etc/sentra
            sudo mv policy.yaml /etc/sentra/
            ```

            ### Quick Start

            ```bash
            # Interactive REPL mode
            sentra --policy /etc/sentra/policy.yaml

            # API mode for OpenClaw VM integration
            sentra --api --port 9800 --policy /etc/sentra/policy.yaml
            ```

            ### Downloads

            | Platform | File | Sandbox Support |
            |----------|------|-----------------|
            | Linux x86_64 | `sentra-linux-x86_64.tar.gz` | Full (namespaces, seccomp, cgroups) |
            | Linux ARM64 | `sentra-linux-aarch64.tar.gz` | Full (namespaces, seccomp, cgroups) |
            | macOS Intel | `sentra-macos-x86_64.tar.gz` | Policy enforcement only |
            | macOS Apple Silicon | `sentra-macos-aarch64.tar.gz` | Policy enforcement only |

            ### Archive Contents

            Each archive contains:
            - `sentra` - Main binary (REPL + API server)
            - `python_runner` - Python sandbox executor
            - `policy.yaml` - Default policy v2.0
            - `README.md` - Documentation
            - `LICENSE` - Apache 2.0

            ### Verification

            Download `checksums.txt` and verify with:
            ```bash
            sha256sum -c checksums.txt
            ```
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
