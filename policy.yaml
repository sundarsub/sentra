# Sentra - Execution Governance Policy
# =====================================
# This policy file defines rules for the Sentra execution gateway.
# Rules are evaluated in order - first match wins.
#
# Version: 2.0
# Schema: v2.0 adds profiles, capabilities, and syscall_profiles sections

version: "2.0"
mode: enforce    # enforce = block denied commands, audit = log only
default: deny    # deny = block unknown commands, allow = permit unknown

# Rate limiting configuration
rate_limit:
  max_commands: 60   # Maximum commands per identity per window
  window_seconds: 60 # Sliding window duration in seconds

# =============================================================================
# v2.1 COST ROUTING (OpenRouter Adapter)
# Budget-based model selection for LLM requests
# =============================================================================

cost_routing:
  # JetPatch console integration (future)
  console:
    enabled: false                              # Toggle local-only vs console-managed
    url: "https://console.jetpatch.com"         # Console API endpoint
    sync_interval_seconds: 30                   # Push spend / pull budget interval
    api_key: "${JETPATCH_API_KEY}"              # From environment variable

  # Spend tracking (append-only log for recovery)
  spend_log: "./spend.jsonl"

  # OpenRouter settings
  openrouter:
    base_url: "https://openrouter.ai/api/v1"    # Production OpenRouter API
    api_key: "${OPENROUTER_API_KEY}"
    timeout_seconds: 120

  # Agent configurations
  agents:
    # Premium agent with tiered model degradation
    agent-1:
      budget_total: 50.00
      budget_spent: 0.00
      budget_source: local                      # local | console
      period: daily                             # daily | weekly | monthly | none
      period_reset: "2025-02-23T00:00:00Z"      # When current period started
      hard_cap: true                            # Block requests when exhausted
      tiers:
        - threshold: 0.80                       # >80% remaining -> premium
          models:
            - "anthropic/claude-3.5-sonnet"
            - "openai/gpt-4o"
        - threshold: 0.30                       # 30-80% remaining -> mid-tier
          models:
            - "anthropic/claude-3-haiku"
            - "openai/gpt-4o-mini"
        - threshold: 0.00                       # <30% remaining -> economy
          models:
            - "mistralai/mistral-7b-instruct"

    # Default fallback agent (economy only, no hard cap)
    default:
      budget_total: 10.00
      budget_spent: 0.00
      budget_source: local
      period: none
      hard_cap: false
      tiers:
        - threshold: 0.00
          models:
            - "mistralai/mistral-7b-instruct"

# =============================================================================
# v2.2 SECCOMP PROFILES
# Configurable syscall filtering for different execution contexts
# Used by openclaw_launcher to apply security restrictions before exec
# =============================================================================

seccomp_profiles:
  # Gateway profile - permissive for OpenClaw gateway process
  # Allows spawn since OpenClaw needs to create subprocesses internally
  gateway:
    default: allow

    # Only block truly dangerous syscalls that should never be needed
    deny_dangerous:
      - ptrace
      - mount
      - umount2
      - pivot_root
      - bpf
      - init_module
      - delete_module
      - finit_module
      - kexec_load
      - kexec_file_load
      - reboot

  # Base profile - blocks dangerous syscalls, allows threads
  # Used for sandboxed code execution (NOT for gateway)
  base_restricted:
    default: allow

    # Process creation - BLOCKED (except threads)
    deny:
      - fork
      - vfork
      - execveat

    # Clone with conditions: allow threads (CLONE_THREAD), block processes
    conditional:
      clone:
        - arg: 0
          mask: 0x10000    # CLONE_THREAD flag
          value: 0         # Block when CLONE_THREAD is NOT set
          action: deny

    # Dangerous syscalls - BLOCKED
    deny_dangerous:
      - ptrace
      - mount
      - umount2
      - pivot_root
      - bpf
      - perf_event_open
      - init_module
      - delete_module
      - finit_module
      - keyctl
      - unshare
      - setns
      - setuid
      - setgid
      - setresuid
      - setresgid
      - setgroups
      - capset
      - reboot
      - kexec_load
      - kexec_file_load
      - swapon
      - swapoff
      - sethostname
      - setdomainname
      - iopl
      - ioperm

  # WhatsApp Agent Profile - allows network for WhatsApp Web
  whatsapp_agent:
    extends: base_restricted

    # Network syscalls needed for WhatsApp/WebSocket
    allow:
      - socket
      - socketpair
      - connect
      - accept
      - accept4
      - bind
      - listen
      - sendto
      - recvfrom
      - sendmsg
      - recvmsg
      - shutdown
      - getsockname
      - getpeername
      - setsockopt
      - getsockopt
      - poll
      - ppoll
      - select
      - pselect6
      - epoll_create
      - epoll_create1
      - epoll_ctl
      - epoll_wait
      - epoll_pwait

    # Network policy (enforced via iptables/nftables, not seccomp)
    network_policy:
      allow_loopback: true
      allow_outbound:
        - "*.whatsapp.net:443"
        - "*.whatsapp.com:443"
        - "web.whatsapp.com:443"
        - "mmg.whatsapp.net:443"
        - "media.whatsapp.com:443"

  # Telegram Agent Profile
  telegram_agent:
    extends: base_restricted

    allow:
      - socket
      - socketpair
      - connect
      - accept
      - accept4
      - bind
      - listen
      - sendto
      - recvfrom
      - sendmsg
      - recvmsg
      - shutdown
      - getsockname
      - getpeername
      - setsockopt
      - getsockopt
      - poll
      - ppoll
      - select
      - pselect6
      - epoll_create
      - epoll_create1
      - epoll_ctl
      - epoll_wait
      - epoll_pwait

    network_policy:
      allow_loopback: true
      allow_outbound:
        - "api.telegram.org:443"
        - "*.telegram.org:443"

  # Isolated Agent - no network, pure code execution
  isolated_agent:
    extends: base_restricted

    deny:
      - socket
      - socketpair
      - connect
      - accept
      - accept4
      - bind
      - listen
      - sendto
      - recvfrom
      - sendmsg
      - recvmsg

    network_policy:
      allow_loopback: true   # Still allow Sentra API
      allow_outbound: []

  # Development Profile - permissive for testing
  development:
    default: allow
    deny:
      - reboot
      - kexec_load
      - init_module
      - delete_module
    deny_dangerous: []

# =============================================================================
# v2.2 LAUNCHER CONFIGURATION
# Settings for openclaw_launcher
# =============================================================================

launcher:
  # Default seccomp profile to apply
  # Use 'gateway' for OpenClaw process (allows spawn)
  # Use 'whatsapp_agent' or 'isolated_agent' for sandboxed code execution
  default_profile: gateway

  # Sentra integration
  sentra:
    enabled: true
    mode: repl                              # repl | api
    binary: /usr/local/bin/sentra
    shell_wrapper: /usr/local/bin/sentra-shell
    python_runner: /usr/lib/sentra/python_runner

  # OpenClaw settings
  openclaw:
    binary: /usr/local/bin/openclaw
    gateway_port: 18789

# =============================================================================
# v2.0 SANDBOX PROFILES
# Defines named execution profiles for sandboxed code execution
# =============================================================================

profiles:
  python_sandbox:
    runner: "/usr/lib/sentra/python_runner"
    python_bin: "/usr/bin/python3"
    deny_spawn_processes: true
    default_network: deny
    fs_defaults:
      cwd: "/work"
      read_allow:
        - "/work"
        - "/usr/lib/python3"
        - "/usr/lib/python3.11"
        - "/usr/lib/python3.12"
        - "/usr/local/lib/python3"
      write_allow:
        - "/work/tmp"
        - "/work/out"
        - "/tmp/sentra"
      protected_deny:
        - "/"
        - "/etc"
        - "/proc"
        - "/sys"
        - "/root"
        - "/home"
        - "/var"
    limits_defaults:
      timeout_sec: 30
      cpu_max_percent: 50
      mem_max_mb: 512
      pids_max: 64
      max_stdout_bytes: 200000
      max_stderr_bytes: 200000
    syscall_profile: python_restricted

  python_sandbox_extended:
    runner: "/usr/lib/sentra/python_runner"
    python_bin: "/usr/bin/python3"
    deny_spawn_processes: false
    default_network: deny
    fs_defaults:
      cwd: "/work"
      read_allow:
        - "/work"
        - "/usr/lib/python3"
        - "/usr/lib/python3.11"
        - "/usr/lib/python3.12"
        - "/usr/local/lib/python3"
        - "/usr/share"
      write_allow:
        - "/work"
        - "/tmp/sentra"
      protected_deny:
        - "/etc/passwd"
        - "/etc/shadow"
        - "/etc/sudoers"
        - "/proc"
        - "/sys"
        - "/root"
    limits_defaults:
      timeout_sec: 120
      cpu_max_percent: 80
      mem_max_mb: 2048
      pids_max: 128
      max_stdout_bytes: 500000
      max_stderr_bytes: 500000
    syscall_profile: python_standard

# =============================================================================
# v2.0 CAPABILITIES
# Defines what sandboxed code execution can do
# =============================================================================

capabilities:
  python:
    type: python
    profile: python_sandbox
    allowed_python_argv:
      - "-c"
      - "-m"
      - "script.py"

  python_extended:
    type: python
    profile: python_sandbox_extended
    allowed_python_argv:
      - "-c"
      - "-m"
      - "-u"
      - "*.py"

  python_readonly:
    type: python
    profile: python_sandbox
    allowed_python_argv:
      - "-c"

# =============================================================================
# v2.0 SYSCALL PROFILES
# Fine-grained syscall filtering for sandboxed execution
# =============================================================================

syscall_profiles:
  python_restricted:
    default: deny
    allow:
      # File operations (read-only primarily)
      - read
      - pread64
      - readv
      - lseek
      - fstat
      - stat
      - lstat
      - fstatat
      - access
      - faccessat
      - openat
      - close
      - fcntl
      - dup
      - dup2
      - dup3
      - getcwd
      - readlink
      - readlinkat
      - getdents
      - getdents64
      # Memory management
      - mmap
      - mprotect
      - munmap
      - brk
      - mremap
      # Process info (read-only)
      - getpid
      - getppid
      - getuid
      - geteuid
      - getgid
      - getegid
      - gettid
      - getrusage
      - times
      - uname
      - sysinfo
      # Signals (limited)
      - rt_sigaction
      - rt_sigprocmask
      - rt_sigreturn
      - sigaltstack
      # Time
      - clock_gettime
      - clock_getres
      - gettimeofday
      - nanosleep
      # Polling/waiting
      - poll
      - ppoll
      - select
      - pselect6
      - epoll_create
      - epoll_create1
      - epoll_ctl
      - epoll_wait
      - epoll_pwait
      - futex
      # Write (controlled)
      - write
      - pwrite64
      - writev
      # Exit
      - exit
      - exit_group
      # Arch specific
      - arch_prctl
      - set_tid_address
      - set_robust_list
      - getrandom
      - prctl
    deny:
      # Process creation/execution - BLOCKED
      - fork
      - vfork
      - clone
      - clone3
      - execve
      - execveat
      # Network - BLOCKED
      - socket
      - socketpair
      - connect
      - accept
      - accept4
      - bind
      - listen
      - sendto
      - recvfrom
      - sendmsg
      - recvmsg
      - shutdown
      - getsockname
      - getpeername
      - setsockopt
      - getsockopt
      # Dangerous file operations
      - unlink
      - unlinkat
      - rmdir
      - rename
      - renameat
      - renameat2
      - link
      - linkat
      - symlink
      - symlinkat
      - chmod
      - fchmod
      - fchmodat
      - chown
      - fchown
      - fchownat
      - mount
      - umount2
      - pivot_root
      - chroot
      # IPC - BLOCKED
      - msgget
      - msgsnd
      - msgrcv
      - semget
      - semop
      - shmget
      - shmat
      - shmdt
      - shmctl
      # Kernel/system - BLOCKED
      - ptrace
      - reboot
      - sethostname
      - setdomainname
      - iopl
      - ioperm
      - init_module
      - delete_module
      - kexec_load
      - perf_event_open
      - bpf
      - userfaultfd
      - memfd_create
      - seccomp

  python_standard:
    default: deny
    allow:
      # All from restricted, plus:
      - read
      - pread64
      - readv
      - lseek
      - fstat
      - stat
      - lstat
      - fstatat
      - access
      - faccessat
      - openat
      - close
      - fcntl
      - dup
      - dup2
      - dup3
      - getcwd
      - readlink
      - readlinkat
      - getdents
      - getdents64
      - mmap
      - mprotect
      - munmap
      - brk
      - mremap
      - getpid
      - getppid
      - getuid
      - geteuid
      - getgid
      - getegid
      - gettid
      - getrusage
      - times
      - uname
      - sysinfo
      - rt_sigaction
      - rt_sigprocmask
      - rt_sigreturn
      - sigaltstack
      - clock_gettime
      - clock_getres
      - gettimeofday
      - nanosleep
      - poll
      - ppoll
      - select
      - pselect6
      - epoll_create
      - epoll_create1
      - epoll_ctl
      - epoll_wait
      - epoll_pwait
      - futex
      - write
      - pwrite64
      - writev
      - exit
      - exit_group
      - arch_prctl
      - set_tid_address
      - set_robust_list
      - getrandom
      - prctl
      # Additional for standard profile
      - clone
      - clone3
      - wait4
      - waitid
      - pipe
      - pipe2
      - mkdir
      - mkdirat
      - unlink
      - unlinkat
      - rename
      - renameat
      - renameat2
      - ftruncate
      - truncate
      - fsync
      - fdatasync
    deny:
      # Network - still blocked
      - socket
      - socketpair
      - connect
      - accept
      - accept4
      - bind
      - listen
      - sendto
      - recvfrom
      - sendmsg
      - recvmsg
      # Execution - blocked
      - execve
      - execveat
      # Dangerous system calls
      - ptrace
      - reboot
      - mount
      - umount2
      - pivot_root
      - chroot
      - init_module
      - delete_module
      - kexec_load
      - perf_event_open
      - bpf
      - userfaultfd
      - seccomp

# =============================================================================
# RULES (v1.0 compatible)
# Rules are evaluated in order - first match wins
# =============================================================================

rules:
  # ===========================================================================
  # EMAIL AND MESSAGING TOOLS
  # Allow email clients and helper scripts for AI agent communication
  # ===========================================================================

  # Email helper scripts (send-email, email commands)
  - id: allow_email_scripts
    match:
      executable: "^(email|send-email)$"
    effect: allow

  # Himalaya CLI email client
  - id: allow_himalaya
    match:
      executable: "^himalaya$"
    effect: allow

  # ===========================================================================
  # DANGEROUS DESTRUCTIVE COMMANDS - ALWAYS DENY (highest priority)
  # ===========================================================================

  - id: block_rm_rf_root
    match:
      executable: "^rm$"
      args_pattern: ".*-[rf]*\\s+/"
    effect: deny
    reason: "Recursive deletion of root filesystem is blocked"

  - id: block_rm_rf_force
    match:
      executable: "^rm$"
      args_pattern: ".*--no-preserve-root"
    effect: deny
    reason: "Bypassing root protection is blocked"

  - id: block_dd_of_dev
    match:
      executable: "^dd$"
      args_pattern: "of=/dev/"
    effect: deny
    reason: "Writing to block devices is blocked"

  - id: block_mkfs
    match:
      executable: "^mkfs"
    effect: deny
    reason: "Filesystem creation is blocked"

  # Allow fdisk/parted in list mode (read-only)
  - id: allow_fdisk_list
    match:
      executable: "^(fdisk|parted|gdisk|sgdisk)$"
      args_pattern: "(-l|--list)"
    effect: allow

  - id: block_fdisk_write
    match:
      executable: "^(fdisk|parted|gdisk|sgdisk)$"
    effect: deny
    reason: "Disk partitioning is blocked (use -l for read-only)"

  # ===========================================================================
  # SHELL INJECTION PREVENTION (highest priority - evaluated first)
  # ===========================================================================

  - id: block_shell_injection
    match:
      args_pattern: "(\\$\\(|`|\\s\\|\\s|\\s;\\s|\\s&&\\s|\\s\\|\\|\\s)"
    effect: deny
    reason: "Shell metacharacter injection blocked - pipes, command chaining, and subshells are not allowed"

  # ===========================================================================
  # VERSION CONTROL - GIT
  # Read-only operations allowed, write operations blocked
  # ===========================================================================

  - id: git_read_only
    match:
      executable: "^git$"
      args_pattern: "^(clone|pull|fetch|status|diff|log|show|branch|ls-files|stash|tag|describe|rev-parse|remote\\s+-v|config\\s+--list)"
    effect: allow

  - id: git_add_commit
    match:
      executable: "^git$"
      args_pattern: "^(add|commit|checkout|switch|restore|merge|rebase|cherry-pick)"
    effect: allow

  - id: git_block_push
    match:
      executable: "^git$"
      args_pattern: "^push"
    effect: deny
    reason: "Git push is blocked - changes must be reviewed before pushing"

  - id: git_block_remote_modify
    match:
      executable: "^git$"
      args_pattern: "^remote\\s+(add|remove|rename|set-url)"
    effect: deny
    reason: "Modifying git remotes is blocked"

  - id: git_block_force
    match:
      executable: "^git$"
      args_pattern: "(--force|-f|reset\\s+--hard|clean\\s+-fd)"
    effect: deny
    reason: "Destructive git operations (force push, hard reset, clean) are blocked"

  # ===========================================================================
  # SAFE READ COMMANDS
  # Common commands for reading/exploring files and system info
  # ===========================================================================

  - id: safe_read_commands
    match:
      executable: "^(ls|cat|head|tail|less|more|grep|egrep|fgrep|rg|ag|ack|find|fd|echo|pwd|whoami|id|date|cal|env|printenv|which|whereis|whatis|file|stat|du|df|wc|sort|uniq|diff|cmp|comm|tr|cut|paste|join|split|tee|xargs|basename|dirname|realpath|readlink|tree|bat|exa|lsd)$"
    effect: allow

  # ===========================================================================
  # FILE OPERATIONS
  # Basic file manipulation (with sensitive file protection below)
  # ===========================================================================

  - id: file_ops_basic
    match:
      executable: "^(cp|mv|mkdir|touch|rm|rmdir|ln)$"
    effect: allow

  - id: archive_ops
    match:
      executable: "^(tar|zip|unzip|gzip|gunzip|bzip2|bunzip2|xz|7z|rar)$"
    effect: allow

  # ===========================================================================
  # BLOCK SENSITIVE FILE ACCESS
  # Deny access to credentials, secrets, and system files
  # ===========================================================================

  - id: block_env_files
    match:
      args_pattern: "\\.env"
    effect: deny
    reason: "Access to .env files is blocked - may contain secrets"

  - id: block_ssh_keys
    match:
      args_pattern: "\\.ssh/"
    effect: deny
    reason: "Access to SSH directory is blocked"

  - id: block_credentials
    match:
      args_pattern: "(credentials|secrets|password|passwd|token|apikey|api_key|private_key)\\.?(json|yaml|yml|txt|env|cfg|conf|ini)?$"
    effect: deny
    reason: "Access to credential files is blocked"

  - id: block_pem_keys
    match:
      args_pattern: "\\.(pem|key|p12|pfx|jks)$"
    effect: deny
    reason: "Access to private key files is blocked"

  - id: block_system_files
    match:
      args_pattern: "^/(etc/passwd|etc/shadow|etc/sudoers)"
    effect: deny
    reason: "Access to system authentication files is blocked"

  # ===========================================================================
  # PERMISSIONS
  # Allow safe permission changes, block dangerous ones
  # ===========================================================================

  - id: chmod_safe
    match:
      executable: "^chmod$"
      args_pattern: "^(644|755|600|400|700|664|775)\\s"
    effect: allow

  - id: chmod_symbolic_safe
    match:
      executable: "^chmod$"
      args_pattern: "^[ugo]?[+-][rwx]+\\s"
    effect: allow

  - id: chmod_block_world_write
    match:
      executable: "^chmod$"
      args_pattern: "(777|666|o\\+w)"
    effect: deny
    reason: "World-writable permissions are blocked"

  - id: chmod_block_setuid
    match:
      executable: "^chmod$"
      args_pattern: "(4[0-7]{3}|u\\+s|\\+s)"
    effect: deny
    reason: "Setuid/setgid bits are blocked"

  # ===========================================================================
  # NETWORK - CURL/WGET
  # Allow fetching from safe domains, block internal network access
  # ===========================================================================

  - id: curl_block_internal
    match:
      executable: "^(curl|wget|http|httpie)$"
      args_pattern: "(127\\.|localhost|0\\.0\\.0\\.0|10\\.|172\\.(1[6-9]|2[0-9]|3[01])\\.|192\\.168\\.|169\\.254\\.)"
    effect: deny
    reason: "SSRF protection: access to internal/private networks is blocked"

  - id: curl_allow
    match:
      executable: "^(curl|wget|http|httpie)$"
    effect: allow

  # ===========================================================================
  # PACKAGE MANAGERS
  # Allow package installation and management
  # ===========================================================================

  - id: npm_allow
    match:
      executable: "^(npm|npx|yarn|pnpm|bun)$"
    effect: allow

  - id: pip_allow
    match:
      executable: "^(pip|pip3|pipx|poetry|pdm|uv)$"
    effect: allow

  - id: cargo_allow
    match:
      executable: "^cargo$"
    effect: allow

  - id: go_allow
    match:
      executable: "^go$"
    effect: allow

  - id: gem_allow
    match:
      executable: "^(gem|bundle|bundler)$"
    effect: allow

  - id: composer_allow
    match:
      executable: "^(composer|php)$"
    effect: allow

  # ===========================================================================
  # BUILD AND TEST TOOLS
  # Allow compilers, build systems, and test runners
  # ===========================================================================

  - id: compilers
    match:
      executable: "^(gcc|g\\+\\+|clang|clang\\+\\+|rustc|javac|scalac|kotlinc|swiftc|tsc)$"
    effect: allow

  - id: build_systems
    match:
      executable: "^(make|cmake|ninja|gradle|mvn|maven|ant|bazel|buck|meson|scons)$"
    effect: allow

  # Python must go through sandbox (python_runner)
  - id: block_direct_python
    match:
      executable: "^(python|python3|python2)$"
    effect: deny
    reason: "Direct Python execution blocked - use Sentra sandbox API for Python code"

  - id: allow_python_runner
    match:
      executable: "python_runner$"
    effect: allow

  - id: allow_sandbox_python
    match:
      executable: "sandbox-python"
    effect: allow

  - id: interpreters_non_python
    match:
      executable: "^(node|ruby|perl|php|lua|julia|R|Rscript)$"
    effect: allow

  - id: test_runners
    match:
      executable: "^(jest|mocha|pytest|py\\.test|rspec|phpunit|cargo|go|npm|yarn)$"
      args_pattern: "(test|spec)"
    effect: allow

  # ===========================================================================
  # EDITORS AND TOOLS
  # Allow common development tools
  # ===========================================================================

  - id: editors
    match:
      executable: "^(vi|vim|nvim|nano|emacs|code|subl|atom|gedit|kate|micro|helix)$"
    effect: allow

  - id: formatters_linters
    match:
      executable: "^(prettier|eslint|rubocop|black|flake8|pylint|mypy|tsc|rustfmt|gofmt|goimports|clang-format)$"
    effect: allow

  - id: docker_basic
    match:
      executable: "^docker$"
      args_pattern: "^(ps|images|logs|inspect|stats|top|version|info)"
    effect: allow

  - id: docker_block_privileged
    match:
      executable: "^docker$"
      args_pattern: "(--privileged|--cap-add|--security-opt|--pid=host|--network=host)"
    effect: deny
    reason: "Privileged Docker operations are blocked"

  # ===========================================================================
  # DANGEROUS COMMANDS - ALWAYS DENY
  # Privilege escalation and system administration
  # ===========================================================================

  - id: block_sudo
    match:
      executable: "^sudo$"
    effect: deny
    reason: "Privilege escalation via sudo is blocked"

  - id: block_su
    match:
      executable: "^(su|doas|pkexec|runuser)$"
    effect: deny
    reason: "Privilege escalation is blocked"

  - id: block_user_management
    match:
      executable: "^(useradd|userdel|usermod|groupadd|groupdel|groupmod|adduser|deluser|addgroup|delgroup)$"
    effect: deny
    reason: "User/group management is blocked"

  - id: block_chown
    match:
      executable: "^chown$"
    effect: deny
    reason: "Changing file ownership is blocked"

  - id: block_system_control
    match:
      executable: "^(systemctl|service|init|initctl|launchctl|rc-service)$"
    effect: deny
    reason: "System service management is blocked"

  - id: block_shutdown
    match:
      executable: "^(shutdown|reboot|poweroff|halt|init)$"
    effect: deny
    reason: "System shutdown/reboot is blocked"

  - id: block_kernel
    match:
      executable: "^(insmod|rmmod|modprobe|sysctl)$"
    effect: deny
    reason: "Kernel module and sysctl operations are blocked"

  - id: block_mount
    match:
      executable: "^(mount|umount|losetup)$"
    effect: deny
    reason: "Mount operations are blocked"

  # ===========================================================================
  # DANGEROUS NETWORK TOOLS - ALWAYS DENY
  # Block raw network access and tunneling
  # ===========================================================================

  - id: block_netcat
    match:
      executable: "^(nc|netcat|ncat|socat)$"
    effect: deny
    reason: "Raw network tools are blocked - use curl/wget for HTTP requests"

  - id: block_ssh
    match:
      executable: "^(ssh|scp|sftp|rsync)$"
    effect: deny
    reason: "SSH/SCP is blocked - direct remote access not allowed"

  - id: block_telnet_ftp
    match:
      executable: "^(telnet|ftp|tftp|rsh|rlogin|rcp)$"
    effect: deny
    reason: "Legacy network protocols are blocked"

  - id: block_nmap
    match:
      executable: "^(nmap|masscan|zmap|nikto)$"
    effect: deny
    reason: "Network scanning tools are blocked"

  # ===========================================================================
  # MISC UTILITIES
  # ===========================================================================

  - id: misc_safe
    match:
      executable: "^(clear|reset|history|alias|type|time|timeout|watch|yes|true|false|seq|shuf|rev|tac|nl|fmt|fold|column|expand|unexpand|od|xxd|hexdump|md5sum|sha1sum|sha256sum|sha512sum|base64|uuidgen|jq|yq|fx|gron)$"
    effect: allow

  - id: man_help
    match:
      executable: "^(man|info|help|apropos)$"
    effect: allow

  - id: process_view
    match:
      executable: "^(ps|top|htop|btop|pgrep|pidof|pstree|lsof|fuser)$"
    effect: allow

  - id: block_kill
    match:
      executable: "^(kill|killall|pkill)$"
    effect: deny
    reason: "Process termination is blocked"

  - id: disk_info
    match:
      executable: "^(df|du|ncdu|lsblk|blkid|fdisk|parted)$"
      args_pattern: "^(-[lah]|--list|--help)?$"
    effect: allow

  - id: network_info
    match:
      executable: "^(ip|ifconfig|netstat|ss|route|arp|ping|traceroute|dig|nslookup|host)$"
    effect: allow

  # ===========================================================================
  # OPENCLAW AI AGENT RULES
  # Rules specifically for OpenClaw AI agent workflows
  # ===========================================================================

  # Allow gh CLI for GitHub operations (read operations)
  - id: gh_read_ops
    match:
      executable: "^gh$"
      args_pattern: "^(issue|pr|repo|release|run|workflow|api)\\s+(list|view|status|diff|checks)"
    effect: allow

  # Block gh write operations that need review
  - id: gh_write_ops
    match:
      executable: "^gh$"
      args_pattern: "^(issue|pr)\\s+(create|close|merge|edit|delete)"
    effect: deny
    reason: "GitHub write operations need manual review"

  # Allow sentra commands
  - id: allow_sentra
    match:
      executable: "sentra$"
    effect: allow

  # Allow OpenClaw to check its own processes
  - id: openclaw_process_check
    match:
      executable: "^(pgrep|ps)$"
      args_pattern: "(openclaw|sentra|python_runner)"
    effect: allow
